!function(){function e(){this._state="pending",this._onFulfilled=[],this._onRejected=[]}function t(){this.name="CancellationError",this.message=" "}function n(e){var t=typeof e;if("string"!==t&&("object"!==t||null===e))throw new TypeError('Controller constructor only accepts non-null el of type "string" or "object"');if("string"===t?(this._selector=e,this.el=document.querySelector(e)):this.el=e,null===this.el)throw new Error('Could not find element for selector "'+e+'"');var n=this.events,r=this;if(n){var i=this.manualHandlers=[];Object.keys(n).forEach(function(e){var t=e.indexOf(" "),o=e.substring(0,t);i.push({type:o,selector:e.substring(t+1,e.length),handler:n[e].bind(r)})})}this._changeListenerDestroyFunctions=[],this._manualListenerDestroyFunctions=[],this._children=[],this._data=Object.freeze({})}var r=function(e,t){var n,r=null,i=e;do{var o=!1;if(t)if(t.tagName===e.tagName)if(1===e.nodeType){for(var s,l=Array.prototype.slice.call(t.attributes),a=0,f=l.length;f>a;a++)s=l[a].name,e.hasAttribute(s)||t.removeAttribute(s);for(l=e.attributes,a=0,f=l.length;f>a;a++){var c=l[a],u=c.value;s=c.name,t.getAttribute(s)!==u&&t.setAttribute(s,u)}t.checked=e.checked}else 3===e.nodeType&&(t.textContent=e.textContent);else n=e.cloneNode(!0),t.parentNode.replaceChild(n,t),t=n,r=t.parentNode,o=!0;else n=e.cloneNode(!0),r.appendChild(n),t=n,r=t.parentNode,o=!0;var h=!o&&e.firstChild;if(h)r=t,t=t.firstChild;else{if(!e.firstChild)for(;t.firstChild;)t.removeChild(t.firstChild);if(h=e.nextSibling)t=t.nextSibling;else{for(;t.nextSibling;)t.parentNode.removeChild(t.nextSibling);do t.nextSibling&&t.parentNode.removeChild(t.nextSibling),t=t.parentNode;while((e=e.parentNode)&&e!==i&&!e.nextSibling);if(e===i)return!1;r=t.parentNode,t=t.nextSibling,h=e&&e.nextSibling}}e=h}while(e)},i=function(e,t){this.key=e,this.value=t};e.parallelize=function(t){var n=t.length,r=[],i=new e;return t.forEach(function(e,t){e.then(function(e){return r[t]=e,0===--n&&i.fulfill(r),e},i.reject.bind(i))}),i},e.serialize=function(t){var n=t.length,r=0,i=[],o=new e;return function s(){var e=t[r++];("function"==typeof e.then?e:e()).then(function(e){i[r]=e,r===n?o.fulfill(i):s()},o.reject.bind(o))}(),o},e.prototype={then:function(e,t){return"fulfilled"===this._state?e&&(this._value=e(this._value)):"rejected"===this._state?t&&(this._reason=t(this._reason)):(e&&this._onFulfilled.push(e),t&&this._onRejected.push(t)),this},fulfill:function(e){if("pending"===this._state){this._state="fulfilled",this._value=e;var t=this;this._onFulfilled.forEach(function(e){t._value=e(t._value)})}return this},reject:function(e){if("pending"===this._state){this._state="rejected",this._reason=e;var t=this;this._onRejected.forEach(function(e){t._reason=e(t._reason)})}return this}};var o="memory",s={memory:{_storage:{},get:function(t){return(new e).fulfill(this._storage[t])},set:function(t,n){return this._storage[t]=n,(new e).fulfill()},destroy:function(t){return delete this._storage[t],(new e).fulfill()}}},l={},a={},f={stores:s,registerStoreForKey:function(e){var t=e.key,n=e.store;if("undefined"==typeof s[n])throw new Error("model.registerStoreForKey passed unknown store: "+n);return a[t]=n,this},registerStore:function(e,t){if("function"!=typeof t.get||"function"!=typeof t.set||"function"!=typeof t.destroy)throw new Error("stores must implement `get`, `set`, and `destroy` functions!");return s[e]=t,this},observe:function(e,t){return(l[e]=l[e]||[]).push(t),function(){for(var n=l[e],r=n.length;r--;)if(n[r]===t){n.splice(r,1),n.length||delete l[e];break}}},get:function(e){return s[a[e]||o].get(e).then(function(t){return new i(e,t)})},set:function(e,t){if("string"!=typeof e)throw new TypeError('model.set only accepts key of type "string"');t=JSON.parse(JSON.stringify(t));var n=this;return s[a[e]||o].set(e,t).then(function(){Object.freeze(t),n.trigger(e,t)})},destroy:function(e){var t=this;return s[a[e]||o].destroy(e).then(function(){t.trigger(e)})},trigger:function(e,t){var n=l[e];n&&(n=n.slice(),setTimeout(function(){n.forEach(function(e){e(t)})},0))}};t.prototype=Object.create(Error.prototype),t.prototype.constructor=t,n.prototype={render:function(){if(this._destroyed)throw new Error("Cannot call `render` on a destroyed Controller");var n=this.datasources,r=this,o=[],s={};r._pending&&(r._pending.cancelled=!0),r._pending=o,r._changeListenerDestroyFunctions.forEach(function(e){e()}),r._manualListenerDestroyFunctions.forEach(function(e){e()});var l=r._changeListenerDestroyFunctions=[];r._manualListenerDestroyFunctions=[],n?(n=n instanceof Array&&n||[n],n.forEach(function(t){o.push(function(){var n=Object.keys(t),a=new Array(n.length);return n.forEach(function(n,i){var o=t[n].call(r,s);if(null!==o&&"undefined"!=typeof o&&"function"==typeof o.then)a[i]=o;else{var l=new e;a[i]=l,l.fulfill(o)}}),e.parallelize(a).then(function(e){o.cancelled||r._destroyed||e.forEach(function(e,t){var o=e instanceof i&&e.key;"string"==typeof o&&(l.push(f.observe(o,function(){r._destroyed||r.render()})),e=e.value),s[n[t]]=e})})})})):o=[(new e).fulfill()];var a=new e;return e.serialize(o).then(function(){if(o.cancelled||r._destroyed)a.reject(new t);else if(r._data=Object.freeze(s),r._pending=null,r._transform(r.el),r._initializeEvents(),r._built)a.fulfill();else{var n=r._createChildren();if(n){n instanceof Array||(n=[n]);var i=new Array(n.length);n.forEach(function(e,t){if(!e._selector)throw new Error("Child controller root elements must be initialized with a string selector and not an element reference!");e.el=r.el.querySelector(e._selector),i[t]=e.render(),r._children.push(e)}),e.parallelize(i).then(a.fulfill.bind(a,a.reject.bind(a)))}else a.fulfill()}}),a.then(function(){r._built=!0})},generateHTML:function(e){throw new Error("Controller.generateHTML must be implemented")},destroy:function(){return this._destroyables&&this._destroyables.forEach(function(e){e()}),this._changeListenerDestroyFunctions.forEach(function(e){e()}),this._manualListenerDestroyFunctions.forEach(function(e){e()}),this._destroyChildren(),this.el.parentNode.removeChild(this.el),this._destroyed=!0,this},own:function(e){if("function"!=typeof e)throw new TypeError('Controller.own only accepts ownable of type "function"');return this._destroyables=this._destroyables||[],this._destroyables.push(e),this},disown:function(e){for(var t=this._destroyables,n=t.length;n--;)t[n]===e&&t.splice(n,1);return this},_createChildren:function(){},_destroyChildren:function(){this._children.forEach(function(e){e.destroy()}),this._children=[]},_initializeEvents:function(){if(this.manualHandlers){var e=this._manualListenerDestroyFunctions,t=this.el,n=this._children;this.manualHandlers.forEach(function(r){var i=t.querySelectorAll(r.selector);n&&n.length&&(i=Array.prototype.filter.call(i,function(e){for(;e;){if(e===t)return!0;for(var r=n.length;r--;)if(n[r].el===e)return!1;e=e.parentNode}}));for(var o=i.length;o--;){var s=i[o];s.addEventListener(r.type,r.handler),e.push(function(){s.removeEventListener(r.type,r.handler)})}})}},_transform:function(e){if(e){var t=document.createElement("body"),n="</"+this.el.tagName.toLowerCase()+">",i=this.el.outerHTML.replace(this.el.innerHTML+n,this.generateHTML(this._data)+n);t.innerHTML=i;for(var o=this._children.length;o--;){var s=this._children[o],l=t.querySelector(s._selector);s._transform(l)||(s.destroy(),this._children.splice(o,1))}r(t.childNodes[0],e);for(var a=this._children;a.length;){var f=[];a.forEach(function(t){t.el=e.querySelector(t._selector),t._manualListenerDestroyFunctions.forEach(function(e){e()}),t._initializeEvents(),f=f.concat(t._children)}),a=f}return!0}}};var c={DOMTransform:r,ModelValue:i,Promise:e,Controller:n,model:f};"function"==typeof define&&define.amd?define(function(){return c}):window.curvilinear=c}();