!function(){function e(){this._state="pending",this._onFulfilled=[],this._onRejected=[]}function t(){this.name="CancellationError",this.message=" "}function n(e){var t=typeof e;if("string"!==t&&("object"!==t||null===e))throw new TypeError('Controller constructor only accepts non-null el of type "string" or "object"');if(this.el="string"===t?document.querySelector(e):e,null===this.el)throw new Error('Could not find element for selector "'+e+'"');var n=this.events,r=this;if(n){var o=this.eventHandlersForType={};Object.keys(n).forEach(function(e){function t(e){e.stopPropagation(),o[s].forEach(function(t){f.call(e.target||e.srcElement,t.selector)&&t.handler.call(r,e)})}var i=e.indexOf(" "),s=e.substring(0,i);o[s]||(o[s]=[],r.el.addEventListener(s,t),r.own(function(){r.el.removeEventListener(s,t)})),o[s].push({selector:e.substring(i+1,e.length),handler:n[e].bind(r)})})}this._changeListenerDestroyFunctions=[],this._children=[],this._data=Object.freeze({})}var r=function(e,t){var n,r=null,o=e;do{var i=!1;if(t)if(t.tagName===e.tagName)if(1===e.nodeType){for(var s,l=Array.prototype.slice.call(t.attributes),a=0,c=l.length;c>a;a++)s=l[a].name,e.hasAttribute(s)||t.removeAttribute(s);for(l=e.attributes,a=0,c=l.length;c>a;a++){var f=l[a],u=f.value;s=f.name,t.getAttribute(s)!==u&&t.setAttribute(s,u)}}else 3===e.nodeType&&(t.textContent=e.textContent);else n=e.cloneNode(!0),t.parentNode.replaceChild(n,t),t=n,r=t.parentNode,i=!0;else n=e.cloneNode(!0),r.appendChild(n),t=n,r=t.parentNode,i=!0;var h=!i&&e.firstChild;if(h)r=t,t=t.firstChild;else if(h=e.nextSibling)t=t.nextSibling;else{do t.nextSibling&&t.parentNode.removeChild(t.nextSibling),t=t.parentNode;while((e=e.parentNode)&&e!==o&&!e.nextSibling);if(e===o)return!1;r=t.parentNode,t=t.nextSibling,h=e&&e.nextSibling}e=h}while(e)},o=function(e,t){this.key=e,this.value=t};e.parallelize=function(t){var n=t.length,r=[],o=new e;return t.forEach(function(e,t){e.then(function(e){return r[t]=e,0===--n&&o.fulfill(r),e},o.reject.bind(o))}),o},e.serialize=function(t){var n=t.length,r=0,o=[],i=new e;return function s(){var e=t[r++];("function"==typeof e.then?e:e()).then(function(e){o[r]=e,r===n?i.fulfill(o):s()},i.reject.bind(i))}(),i},e.prototype={then:function(e,t){return"fulfilled"===this._state?e&&(this._value=e(this._value)):"rejected"===this._state?t&&(this._reason=t(this._reason)):(e&&this._onFulfilled.push(e),t&&this._onRejected.push(t)),this},fulfill:function(e){if("pending"===this._state){this._state="fulfilled",this._value=e;var t=this;this._onFulfilled.forEach(function(e){t._value=e(t._value)})}},reject:function(e){if("pending"===this._state){this._state="rejected",this._reason=e;var t=this;this._onRejected.forEach(function(e){t._reason=e(t._reason)})}}};var i="memory",s={memory:{_storage:{},get:function(e){return this._storage[e]},set:function(e,t){this._storage[e]=t},destroy:function(e){delete this._storage[e]}}},l={},a={},c={registerStoreForKey:function(e,t){if("undefined"==typeof s[t])throw new Error("model.registerStoreForKey passed unknown store: "+t);return a[e]=t,this},registerStore:function(e,t){if("function"!=typeof t.get||"function"!=typeof t.set||"function"!=typeof t.destroy)throw new Error("stores must implement `get`, `set`, and `destroy` functions!");return s[e]=t,this},observe:function(e,t){return(l[e]=l[e]||[]).push(t),function(){for(var n=l[e],r=n.length;r--;)if(n[r]===t){n.splice(r,1),n.length||delete l[e];break}}},get:function(e){return new o(e,s[a[e]||i].get(e))},set:function(e,t){if("string"!=typeof e)throw new TypeError('model.set only accepts key of type "string"');t=JSON.parse(JSON.stringify(t)),Object.freeze(t),s[a[e]||i].set(e,t);var n=l[e];return n&&(n=n.slice(),setTimeout(function(){n.forEach(function(e){e(t)})},0)),this},destroy:function(e){return s[a[e]||i].destroy(e),this}};t.prototype=Object.create(Error.prototype),t.prototype.constructor=t;var f=Element.prototype.matches||Element.prototype.mozMatchesSelector||Element.prototype.webkitMatchesSelector||Element.prototype.msMatchesSelector;n.prototype={render:function(){if(this._destroyed)throw new Error("Cannot call `render` on a destroyed Controller");var n=this.datasources;if(null===n||"undefined"==typeof n)throw new Error("Controller.datasources must be an Object or an Array of Object");n=n instanceof Array&&n||[n];var r=this,i=[],s={};r._pending&&(r._pending.cancelled=!0),r._pending=i,r._changeListenerDestroyFunctions.forEach(function(e){e(),r.disown(e)});var l=r._changeListenerDestroyFunctions=[];n.forEach(function(t){i.push(function(){var n=Object.keys(t),a=new Array(n.length);return n.forEach(function(n,o){var i=t[n].call(r,s);if("function"==typeof i.then)a[o]=i;else{var l=new e;a[o]=l,l.fulfill(i)}}),e.parallelize(a).then(function(e){i.cancelled||e.forEach(function(e,t){var i=e instanceof o&&e.key;"string"==typeof i&&(l.push(c.observe(i,r.render.bind(r))),e=e.value),s[n[t]]=e})})})});var a=new e;return e.serialize(i).then(function(){if(i.cancelled)a.reject(new t);else{r._data=Object.freeze(s),r._pending=null,r._destroyChildren();var e="</"+r.el.tagName.toLowerCase()+">";r._transform(r.el,r.el.outerHTML.replace(r.el.innerHTML+e,r.generateHTML(r._data)+e));var n=r._createChildren(r._data);n&&(n instanceof Array||(n=[n]),n.forEach(function(e){e.render(),r._children.push(e)})),a.fulfill()}}),a},generateHTML:function(e){throw new Error("Controller.generateHTML must be implemented")},destroy:function(){return this._destroyables&&this._destroyables.forEach(function(e){e()}),this._changeListenerDestroyFunctions.forEach(function(e){e()}),this._destroyChildren(),this.el.parentNode.removeChild(this.el),this._destroyed=!0,this},own:function(e){if("function"!=typeof e)throw new TypeError('Controller.own only accepts ownable of type "function"');return this._destroyables=this._destroyables||[],this._destroyables.push(e),this},disown:function(e){for(var t=this._destroyables,n=t.length;n--;)t[n]===e&&t.splice(n,1);return this},_createChildren:function(e){},_destroyChildren:function(){this._children.forEach(function(e){e.destroy()}),this._children=[]},_transform:function(e,t){var n=document.createElement("body");n.innerHTML=t,r(n.childNodes[0],e)}};var u={DOMTransform:r,ModelValue:o,Promise:e,Controller:n,model:c};"function"==typeof define&&define.amd?define(function(){return u}):window.curvilinear=u}();
