!function(){function e(e){var t=typeof e;if("string"!==t&&("object"!==t||null===e))throw new TypeError('Controller constructor only accepts non-null el of type "string" or "object"');if("string"===t?(this._selector=e,this.el=document.querySelector(e)):this.el=e,null===this.el)throw new Error('Could not find element for selector "'+e+'"');this._changeListenerDestructors={},this._childInstances={},this._eventListeners=[],this._cache={}}var t=function(e,t,n){var r,i,o=null,s=e;if(n){var l=Object.keys(n);i=new Array(l.length),l.forEach(function(e,t){i[t]=n[e].el})}do{var c=!1,a=!1;if(t)if(i&&i.indexOf(t)!==-1)a=!0;else if(t.tagName===e.tagName)if(1===e.nodeType){for(var f,h=Array.prototype.slice.call(t.attributes),u=0,d=h.length;u<d;u++)f=h[u].name,e.hasAttribute(f)||t.removeAttribute(f);for(h=e.attributes,u=0,d=h.length;u<d;u++){var g=h[u],y=g.value;f=g.name,t.getAttribute(f)!==y&&t.setAttribute(f,y)}t.checked=e.checked}else 3===e.nodeType&&(t.textContent=e.textContent);else r=e.cloneNode(!0),t.parentNode.replaceChild(r,t),t=r,o=t.parentNode,c=!0;else r=e.cloneNode(!0),o.appendChild(r),t=r,o=t.parentNode,c=!0;var p=!c&&e.firstChild;if(p)o=t,t=t.firstChild;else{if(!a&&!e.firstChild)for(;t.firstChild;)t.removeChild(t.firstChild);if(p=e.nextSibling)t=t.nextSibling;else{for(;t.nextSibling;)t.parentNode.removeChild(t.nextSibling);do t.nextSibling&&t.parentNode.removeChild(t.nextSibling),t=t.parentNode;while((e=e.parentNode)&&e!==s&&!e.nextSibling);if(e===s)return;o=t.parentNode,t=t.nextSibling,p=e&&e.nextSibling}}e=p}while(e)},n=function(e,t){this.key=e,this.value=t},r="memory",i={memory:{_storage:{},get:function(e,t){t(null,this._storage[e])},set:function(e,t,n){this._storage[e]=t,n(null)},destroy:function(e,t){delete this._storage[e],t(null)}}},o={},s={},l={},c=function(e,t){e in l||setTimeout(function(){Object.freeze(l[e]),a.trigger(e,l[e]),delete l[e]},0),l[e]=t},a={stores:i,registerStoreForKey:function(e){var t=e.key,n=e.store;if("undefined"==typeof i[n])throw new Error("model.registerStoreForKey passed unknown store: "+n);return s[t]=n,this},registerStore:function(e,t){if("function"!=typeof t.get||"function"!=typeof t.set||"function"!=typeof t.destroy)throw new Error("stores must implement `get`, `set`, and `destroy` functions!");return i[e]=t,this},observe:function(e,t){return(o[e]=o[e]||[]).push(t),function(){var n=o[e];if(n)for(var r=n.length;r--;)if(n[r]===t){n.splice(r,1),n.length||delete o[e];break}}},get:function(e,t){return i[s[e]||r].get(e,function(r,i){t&&(r?t(r):t(null,new n(e,i)))}),this},set:function(e,t,n){if("string"!=typeof e)throw new TypeError('model.set only accepts key of type "string"');return this.get(e,function(o,l){o?n&&n(o):l.value!==t?(t=JSON.parse(JSON.stringify(t)),i[s[e]||r].set(e,t,function(r){r||c(e,t),n&&n(r)})):n&&n()}),this},destroy:function(e,t){return this.get(e,function(n,o){n?t&&t(n):"undefined"!=typeof o.value?i[s[e]||r].destroy(e,function(n){n||c(e,void 0),t&&t(n)}):t&&t()}),this},trigger:function(e,t){var n=o[e];n&&(n=n.slice(),setTimeout(function(){n.forEach(function(e){e(t)})},0))}};e.prototype={_resolveDataSourceCollection:function(e,t,r,i){function o(r,o){var s=o instanceof n&&o.key;"string"==typeof s&&(u.push(a.observe(s,function(){f.start(e)})),o=o.value),t[r]=o,h[e]||(h[e]={}),h[e][r]=o,++c===l&&i()}var s=Object.keys(r),l=s.length,c=0,f=this,h=this._cache,u=this._changeListenerDestructors[e];u&&u.forEach(function(e){e()}),this._changeListenerDestructors[e]=u=[],s.forEach(function(e){try{var n=r[e].call(f,JSON.parse(JSON.stringify(t)));n&&"function"==typeof n.then?n.then(function(t){o(e,t)},i):o(e,n)}catch(e){i(e)}})},_resolveDataSources:function(e,t){var n=this.datasources,r={},i=this;if(n)if(n instanceof Array){var o=e,s=n.length;if(e>0)for(var l=0;l<e;l++){var c=i._cache[l];for(var a in c)r[a]=c[a]}!function e(){i._resolveDataSourceCollection(o,r,n[o],function(n){n?t(n):++o<s?e():t(null,Object.freeze(r))})}()}else this._resolveDataSourceCollection(null,r,n,function(e){e?t(e):t(null,Object.freeze(r))});else t(null,Object.freeze(r))},_attachEventHandlers:function(){var e=this.events;if(e&&"object"==typeof e){var t=this._childInstances,n=this;n._eventListeners.forEach(function(e){e()}),Object.keys(e).forEach(function(r){var i=r.indexOf(" "),o=r.substring(0,i),s=n.el.querySelectorAll(r.substring(i+1,r.length));if(s){var l=Object.keys(t),c=l.length,a=function(i){var o=!0,s=i.target;if(s!==this)for(;s&&s!==n.el;){for(var c=0;c<l.length;c++)if(t[l[c]].el===s){o=!1;break}s=s.parentNode}o&&(i.stopPropagation(),e[r].call(n,i))};c&&(s=Array.prototype.filter.call(s,function(e){for(;e;){if(e===n.el)return!0;for(var r=0;r<c;r++)if(t[l[r]].el===e)return!1;e=e.parentNode}return!1})),Array.prototype.forEach.call(s,function(e){e.addEventListener(o,a),n._eventListeners.push(function(){e.removeEventListener(o,a)})})}})}},_transform:function(e,n,r,i){var o=this._childInstances,s=0,l=0,c=this;t(n.childNodes[0],e,o),c.el=e;for(var a in this.children){var f=e.querySelector(a);f?o[a]||(o[a]=this.children[a].call(this,f),o[a]._parentPending=r,s++,o[a].start(function(e){e?i&&i(e):++l===s&&(c._attachEventHandlers(),i&&i())})):o[a]&&(o[a].destroy(),delete o[a])}s||(this._attachEventHandlers(),i&&i())},generateHTML:function(e){throw new Error("Controller.generateHTML must be implemented")},destroy:function(){if(!this._destroyed){this._destroyables&&this._destroyables.forEach(function(e){e()});var e;for(e in this._changeListenerDestructors)this._changeListenerDestructors[e].forEach(function(e){e()});for(e in this._childInstances)this._childInstances[e].destroy();this._eventListeners.forEach(function(e){e()}),this.el.parentNode&&this.el.parentNode.removeChild(this.el),this._changeListenerDestructors=this._childInstances=this._eventListeners=this._cache=null,this._destroyed=!0}return this},own:function(e){if("function"!=typeof e)throw new TypeError('Controller.own only accepts ownable of type "function"');return this._destroyables=this._destroyables||[],this._destroyables.push(e),this},disown:function(e){for(var t=this._destroyables,n=t.length;n--;)t[n]===e&&t.splice(n,1);return this},start:function(e,t){function n(e){r._pending=null;for(var n in r._childInstances)r._childInstances[n]._parentPending=null;t&&t(e)}if(this._destroyed)throw new Error("Cannot start destroyed Controller!");e&&"function"==typeof e&&(t=e,e=null);var r=this;this._pending&&(this._pending.cancelled=!0);var i=this._pending={};return this._resolveDataSources(e||0,function(e,t){if(!i.cancelled){if(r._parentPending&&r._parentPending.cancelled)return void(i.cancelled=!0);if(e)n(e);else{var o=document.createElement("body"),s="</"+r.el.tagName.toLowerCase()+">";try{o.innerHTML=r.el.outerHTML.replace(r.el.innerHTML+s,r.generateHTML(t)+s),r._transform(r.el,o,i,n)}catch(e){n(e)}}}}),this}};var f={DOMTransform:t,ModelValue:n,Controller:e,model:a};"function"==typeof define&&define.amd?define(function(){return f}):window.engine=f}();
