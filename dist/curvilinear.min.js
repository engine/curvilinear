!function(){function e(){this.name="CancellationError",this.message=" "}function t(e){var t=typeof e;if("string"!==t&&("object"!==t||null===e))throw new TypeError('Controller constructor only accepts non-null el of type "string" or "object"');if("string"===t?(this._selector=e,this.el=document.querySelector(e)):this.el=e,null===this.el)throw new Error('Could not find element for selector "'+e+'"');var n=this.events,r=this;if(n){var i=this.manualHandlers=[];Object.keys(n).forEach(function(e){var t=e.indexOf(" "),o=e.substring(0,t);i.push({type:o,selector:e.substring(t+1,e.length),handler:n[e].bind(r)})})}this._changeListenerDestroyFunctions=[],this._manualListenerDestroyFunctions=[],this._children=[],this._data=Object.freeze({})}var n=function(e,t){var n,r=null,i=e;do{var o=!1;if(t)if(t.tagName===e.tagName)if(1===e.nodeType){for(var s,l=Array.prototype.slice.call(t.attributes),a=0,c=l.length;c>a;a++)s=l[a].name,e.hasAttribute(s)||t.removeAttribute(s);for(l=e.attributes,a=0,c=l.length;c>a;a++){var h=l[a],f=h.value;s=h.name,t.getAttribute(s)!==f&&t.setAttribute(s,f)}t.checked=e.checked}else 3===e.nodeType&&(t.textContent=e.textContent);else n=e.cloneNode(!0),t.parentNode.replaceChild(n,t),t=n,r=t.parentNode,o=!0;else n=e.cloneNode(!0),r.appendChild(n),t=n,r=t.parentNode,o=!0;var u=!o&&e.firstChild;if(u)r=t,t=t.firstChild;else{if(!e.firstChild)for(;t.firstChild;)t.removeChild(t.firstChild);if(u=e.nextSibling)t=t.nextSibling;else{for(;t.nextSibling;)t.parentNode.removeChild(t.nextSibling);do t.nextSibling&&t.parentNode.removeChild(t.nextSibling),t=t.parentNode;while((e=e.parentNode)&&e!==i&&!e.nextSibling);if(e===i)return!1;r=t.parentNode,t=t.nextSibling,u=e&&e.nextSibling}}e=u}while(e)},r=function(e,t){this.key=e,this.value=t},i="memory",o={memory:{_storage:{},get:function(e,t){t(null,this._storage[e])},set:function(e,t,n){this._storage[e]=t,n(null)},destroy:function(e,t){delete this._storage[e],t(null)}}},s={},l={},a={stores:o,registerStoreForKey:function(e){var t=e.key,n=e.store;if("undefined"==typeof o[n])throw new Error("model.registerStoreForKey passed unknown store: "+n);return l[t]=n,this},registerStore:function(e,t){if("function"!=typeof t.get||"function"!=typeof t.set||"function"!=typeof t.destroy)throw new Error("stores must implement `get`, `set`, and `destroy` functions!");return o[e]=t,this},observe:function(e,t){return(s[e]=s[e]||[]).push(t),function(){for(var n=s[e],r=n.length;r--;)if(n[r]===t){n.splice(r,1),n.length||delete s[e];break}}},get:function(e,t){return o[l[e]||i].get(e,function(n,i){t&&(n?t(n):t(null,new r(e,i)))}),this},set:function(e,t,n){if("string"!=typeof e)throw new TypeError('model.set only accepts key of type "string"');t=JSON.parse(JSON.stringify(t));var r=this;return o[l[e]||i].set(e,t,function(i){i||(Object.freeze(t),r.trigger(e,t)),n&&n(i)}),this},destroy:function(e,t){var n=this;return o[l[e]||i].destroy(e,function(r){r||n.trigger(e),t&&t(r)}),this},trigger:function(e,t){var n=s[e];n&&(n=n.slice(),setTimeout(function(){n.forEach(function(e){e(t)})},0))}};e.prototype=Object.create(Error.prototype),e.prototype.constructor=e,t.prototype={render:function(t){function n(e){e||(o._built=!0),t&&t(e)}try{if(this._destroyed)throw new Error("Cannot call `render` on a destroyed Controller");var i=this.datasources,o=this,s={};this._pending&&(this._pending.cancelled=!0);var l=this._pending={};o._changeListenerDestroyFunctions.forEach(function(e){e()}),o._manualListenerDestroyFunctions.forEach(function(e){e()});var c=o._changeListenerDestroyFunctions=[];o._manualListenerDestroyFunctions=[];var h;i&&(i=i instanceof Array&&i||[i],h=new Array(i.length),i.forEach(function(t,n){h[n]=function(n){var i=Object.keys(t),h=new Array(i.length),f=0;i.forEach(function(u,d){function y(e){try{h[d]=e,++f===i.length&&(h.forEach(function(e,t){var n=e instanceof r&&e.key;"string"==typeof n&&(c.push(a.observe(n,function(){o._destroyed||o.render()})),e=e.value),s[i[t]]=e}),n())}catch(t){n(t)}}var g=t[u].call(o,s);g&&"function"==typeof g.then?g.then(function(t){l.cancelled||o._destroyed?n(new e):y(t)}):y(g)})}})),function u(e){if(e)n(e);else if(h&&h.length)h.shift()(u);else if(o._data=Object.freeze(s),o._pending=null,o._transform(o.el),o._initializeEvents(),o._built)n();else{var t=o._createChildren();if(t){t instanceof Array||(t=[t]);var r=0;t.forEach(function(e,i){if(!e._selector)throw new Error("Child controller root elements must be initialized with a string selector and not an element reference!");e.el=o.el.querySelector(e._selector),e.render(function(e){e?n(e):++r===t.length&&n()}),o._children.push(e)})}else n()}}()}catch(f){n(f)}},generateHTML:function(e){throw new Error("Controller.generateHTML must be implemented")},detach:function(){return this.el&&(this._changeListenerDestroyFunctions.forEach(function(e){e()}),this._manualListenerDestroyFunctions.forEach(function(e){e()}),this._children.forEach(function(e){e.detach()}),this.el.parentNode.removeChild(this.el),this.el=null),this},destroy:function(){return this._destroyed||(this._destroyables&&this._destroyables.forEach(function(e){e()}),this._changeListenerDestroyFunctions.forEach(function(e){e()}),this._manualListenerDestroyFunctions.forEach(function(e){e()}),this._children.forEach(function(e){e.destroy()}),this._children=null,this.el.parentNode.removeChild(this.el),this.el=null,this._destroyed=!0),this},own:function(e){if("function"!=typeof e)throw new TypeError('Controller.own only accepts ownable of type "function"');return this._destroyables=this._destroyables||[],this._destroyables.push(e),this},disown:function(e){for(var t=this._destroyables,n=t.length;n--;)t[n]===e&&t.splice(n,1);return this},_createChildren:function(){},_initializeEvents:function(){if(this.manualHandlers){var e=this._manualListenerDestroyFunctions,t=this.el,n=this._children;this.manualHandlers.forEach(function(r){var i=t.querySelectorAll(r.selector);n&&n.length&&(i=Array.prototype.filter.call(i,function(e){for(;e;){if(e===t)return!0;for(var r=n.length;r--;)if(n[r].el===e)return!1;e=e.parentNode}})),Array.prototype.forEach.call(i,function(t){t.addEventListener(r.type,r.handler),e.push(function(){t.removeEventListener(r.type,r.handler)})})})}},_transform:function(e){if(e){var t=document.createElement("body"),r="</"+this.el.tagName.toLowerCase()+">",i=this.el.outerHTML.replace(this.el.innerHTML+r,this.generateHTML(this._data)+r);t.innerHTML=i;for(var o=this._children.length;o--;){var s=this._children[o],l=t.querySelector(s._selector);l&&!s.el&&(s.el=l),s._transform(l)||s.detach()}n(t.childNodes[0],e);for(var a,c=this._children;c.length;)a=[],c.forEach(function(t){t.el&&(t.el=e.querySelector(t._selector),t._manualListenerDestroyFunctions.forEach(function(e){e()}),t._initializeEvents(),a=a.concat(t._children))}),c=a;return!0}}};var c={DOMTransform:n,ModelValue:r,Controller:t,model:a};"function"==typeof define&&define.amd?define(function(){return c}):window.curvilinear=c}();